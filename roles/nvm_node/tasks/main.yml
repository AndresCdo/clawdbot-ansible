---
- name: Install system dependencies
  become: true
  apt:
    name:
      - curl
      - git
      - build-essential
    state: present
    update_cache: yes

- name: Check if NVM is already installed
  stat:
    path: "{{ nvm_install_dir }}/nvm.sh"
  register: nvm_installed

- name: Clone NVM repository
  git:
    repo: "https://github.com/nvm-sh/nvm.git"
    dest: "{{ nvm_install_dir }}"
    version: "v{{ nvm_version }}"
    force: yes
    recursive: no
  when: not nvm_installed.stat.exists

- name: Ensure NVM directory ownership
  file:
    path: "{{ nvm_install_dir }}"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    recurse: yes
  when: nvm_installed.stat.exists

- name: Set up NVM environment in shell profiles
  blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    block: |
      export NVM_DIR="{{ nvm_install_dir }}"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - NVM"

- name: Source NVM to current shell
  shell: |
    export NVM_DIR="{{ nvm_install_dir }}" && . "$NVM_DIR/nvm.sh"
  changed_when: false

- name: Install Node.js {{ node_version }} via NVM
  shell: |
    export NVM_DIR="{{ nvm_install_dir }}"
    . "$NVM_DIR/nvm.sh"
    nvm install {{ node_version }}
    nvm alias default {{ node_version }}
  args:
    executable: /bin/bash
  environment:
    NVM_DIR: "{{ nvm_install_dir }}"

- name: Verify Node.js installation
  shell: |
    export NVM_DIR="{{ nvm_install_dir }}"
    . "$NVM_DIR/nvm.sh"
    node --version
  register: node_version_out
  changed_when: false

- name: Debug Node version
  debug:
    msg: "Node.js {{ node_version_out.stdout }} installed"